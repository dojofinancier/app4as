generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                    @id @default(uuid())
  role                     Role                      @default(student)
  firstName                String                    @map("first_name")
  lastName                 String                    @map("last_name")
  email                    String                    @unique
  phone                    String?
  createdAt                DateTime                  @default(now()) @map("created_at")
  stripeCustomerId         String?                   @map("stripe_customer_id")
  defaultPaymentMethodId   String?                   @map("default_payment_method_id")
  creditBalance            Decimal?                  @default(0) @map("credit_balance") @db.Decimal(10, 2)
  appointmentModifications AppointmentModification[]
  appointments             Appointment[]
  carts                    Cart[]
  creditTransactions       CreditTransaction[]
  receivedMessages         Message[]                 @relation("ReceivedMessages")
  sentMessages             Message[]                 @relation("SentMessages")
  orders                   Order[]
  recurringSessions        RecurringSession[]
  processedRefunds         RefundRequest[]           @relation("ProcessedRefunds")
  refundRequests           RefundRequest[]
  slotHolds                SlotHold[]
  tutor                    Tutor?

  @@index([defaultPaymentMethodId], map: "idx_users_default_payment_method_id")
  @@index([stripeCustomerId], map: "idx_users_stripe_customer_id")
  @@map("users")
}

model Course {
  id                String             @id @default(uuid())
  slug              String             @unique
  titleFr           String             @map("title_fr")
  descriptionFr     String             @map("description_fr")
  active            Boolean            @default(true)
  createdAt         DateTime           @default(now()) @map("created_at")
  studentRateCad    Decimal            @default(45.00) @map("student_rate_cad") @db.Decimal(10, 2)
  appointments      Appointment[]
  cartItems         CartItem[]
  orderItems        OrderItem[]
  recurringSessions RecurringSession[]
  slotHolds         SlotHold[]
  tutorCourses      TutorCourse[]

  @@map("courses")
}

model Tutor {
  id                     String                  @id
  displayName            String                  @map("display_name")
  bioFr                  String                  @map("bio_fr")
  hourlyBaseRateCad      Decimal                 @map("hourly_base_rate_cad") @db.Decimal(10, 2)
  priority               Int                     @default(100)
  active                 Boolean                 @default(true)
  appointments           Appointment[]
  availabilityExceptions AvailabilityException[]
  availabilityRules      AvailabilityRule[]
  cartItems              CartItem[]
  externalCalendars      ExternalCalendar[]
  orderItems             OrderItem[]
  recurringSessions      RecurringSession[]
  slotHolds              SlotHold[]
  timeOff                TimeOff[]
  tutorCourses           TutorCourse[]
  user                   User                    @relation(fields: [id], references: [id], onDelete: Cascade)

  @@map("tutors")
}

model TutorCourse {
  id       String  @id @default(uuid())
  tutorId  String  @map("tutor_id")
  courseId String  @map("course_id")
  active   Boolean @default(true)
  course   Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tutor    Tutor   @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@unique([tutorId, courseId])
  @@index([courseId])
  @@map("tutor_courses")
}

model AvailabilityRule {
  id        String @id @default(uuid())
  tutorId   String @map("tutor_id")
  weekday   Int
  startTime String @map("start_time")
  endTime   String @map("end_time")
  tutor     Tutor  @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([tutorId, weekday])
  @@map("availability_rules")
}

model AvailabilityException {
  id        String  @id @default(uuid())
  tutorId   String  @map("tutor_id")
  date      String
  startTime String  @map("start_time")
  endTime   String  @map("end_time")
  isOpen    Boolean @map("is_open")
  tutor     Tutor   @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([tutorId, date])
  @@map("availability_exceptions")
}

model TimeOff {
  id            String   @id @default(uuid())
  tutorId       String   @map("tutor_id")
  startDatetime DateTime @map("start_datetime")
  endDatetime   DateTime @map("end_datetime")
  tutor         Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([tutorId, startDatetime])
  @@map("time_off")
}

model ExternalCalendar {
  id                    String                   @id @default(uuid())
  tutorId               String                   @map("tutor_id")
  provider              ExternalCalendarProvider
  accountEmail          String                   @map("account_email")
  accessTokenEncrypted  String                   @map("access_token_encrypted")
  refreshTokenEncrypted String                   @map("refresh_token_encrypted")
  expiresAt             DateTime                 @map("expires_at")
  active                Boolean                  @default(true)
  tutor                 Tutor                    @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([tutorId])
  @@map("external_calendars")
}

model Coupon {
  id              String     @id @default(uuid())
  code            String     @unique
  type            CouponType
  value           Decimal    @db.Decimal(10, 2)
  active          Boolean    @default(true)
  startsAt        DateTime?  @map("starts_at")
  endsAt          DateTime?  @map("ends_at")
  maxRedemptions  Int?       @map("max_redemptions")
  redemptionCount Int        @default(0) @map("redemption_count")
  carts           Cart[]

  @@map("coupons")
}

model Cart {
  id        String     @id @default(uuid())
  userId    String?    @map("user_id")
  couponId  String?    @map("coupon_id")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  sessionId String?    @map("session_id")
  items     CartItem[]
  coupon    Coupon?    @relation(fields: [couponId], references: [id])
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId], map: "idx_carts_session_id")
  @@map("carts")
}

model CartItem {
  id            String   @id @default(uuid())
  cartId        String   @map("cart_id")
  courseId      String   @map("course_id")
  tutorId       String   @map("tutor_id")
  startDatetime DateTime @map("start_datetime")
  durationMin   Int      @map("duration_min")
  unitPriceCad  Decimal  @map("unit_price_cad") @db.Decimal(10, 2)
  lineTotalCad  Decimal  @map("line_total_cad") @db.Decimal(10, 2)
  cart          Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tutor         Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([cartId])
  @@map("cart_items")
}

model SlotHold {
  id                 String            @id @default(uuid())
  userId             String?           @map("user_id")
  tutorId            String            @map("tutor_id")
  courseId           String            @map("course_id")
  startDatetime      DateTime          @map("start_datetime")
  durationMin        Int               @map("duration_min")
  expiresAt          DateTime          @map("expires_at")
  recurringSessionId String?           @map("recurring_session_id")
  sessionId          String?           @map("session_id")
  course             Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  recurringSession   RecurringSession? @relation(fields: [recurringSessionId], references: [id], onUpdate: NoAction)
  tutor              Tutor             @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  user               User?             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tutorId, startDatetime])
  @@index([startDatetime, tutorId, expiresAt])
  @@index([sessionId, tutorId, startDatetime, expiresAt], map: "idx_slot_holds_session")
  @@map("slot_holds")
}

model Order {
  id                      String      @id @default(uuid())
  userId                  String      @map("user_id")
  subtotalCad             Decimal     @map("subtotal_cad") @db.Decimal(10, 2)
  discountCad             Decimal     @default(0) @map("discount_cad") @db.Decimal(10, 2)
  totalCad                Decimal     @map("total_cad") @db.Decimal(10, 2)
  currency                String      @default("CAD")
  stripePaymentIntentId   String?     @unique @map("stripe_payment_intent_id")
  stripeCheckoutSessionId String?     @unique @map("stripe_checkout_session_id")
  status                  OrderStatus @default(created)
  createdAt               DateTime    @default(now()) @map("created_at")
  items                   OrderItem[]
  user                    User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("orders")
}

model OrderItem {
  id               String       @id @default(uuid())
  orderId          String       @map("order_id")
  courseId         String       @map("course_id")
  tutorId          String       @map("tutor_id")
  startDatetime    DateTime     @map("start_datetime")
  durationMin      Int          @map("duration_min")
  unitPriceCad     Decimal      @map("unit_price_cad") @db.Decimal(10, 2)
  lineTotalCad     Decimal      @map("line_total_cad") @db.Decimal(10, 2)
  endDatetime      DateTime     @default(now()) @map("end_datetime") @db.Timestamptz(6)
  tutorEarningsCad Decimal      @default(0.00) @map("tutor_earnings_cad") @db.Decimal(10, 2)
  appointment      Appointment?
  course           Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  order            Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  tutor            Tutor        @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_items")
}

model Appointment {
  id                 String                    @id @default(uuid())
  userId             String                    @map("user_id")
  tutorId            String                    @map("tutor_id")
  courseId           String                    @map("course_id")
  startDatetime      DateTime                  @map("start_datetime")
  endDatetime        DateTime                  @map("end_datetime")
  status             AppointmentStatus         @default(scheduled)
  orderItemId        String                    @unique @map("order_item_id")
  cancellationReason String?                   @map("cancellation_reason")
  cancelledBy        String?                   @map("cancelled_by")
  cancelledAt        DateTime?                 @map("cancelled_at") @db.Timestamp(6)
  recurringSessionId String?                   @map("recurring_session_id")
  modifications      AppointmentModification[]
  course             Course                    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  orderItem          OrderItem                 @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  recurringSession   RecurringSession?         @relation(fields: [recurringSessionId], references: [id], onUpdate: NoAction)
  tutor              Tutor                     @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  user               User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditTransactions CreditTransaction[]
  messages           Message[]
  refundRequests     RefundRequest[]

  @@index([startDatetime, tutorId])
  @@index([userId])
  @@index([recurringSessionId], map: "idx_appointments_recurring_session_id")
  @@map("appointments")
}

model WebhookEvent {
  id          String        @id @default(uuid())
  source      WebhookSource
  type        String
  payloadJson String        @map("payload_json")
  processedAt DateTime?     @map("processed_at")
  createdAt   DateTime      @default(now()) @map("created_at")

  @@index([source, type])
  @@map("webhook_events")
}

model PaymentIntentData {
  id              String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  paymentIntentId String   @unique @map("payment_intent_id")
  cartData        String   @map("cart_data")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([paymentIntentId], map: "idx_payment_intent_data_payment_intent_id")
  @@map("payment_intent_data")
}

model CreditTransaction {
  id            String       @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId        String       @map("user_id")
  appointmentId String?      @map("appointment_id")
  amount        Decimal      @map("amount") @db.Decimal(10, 2)
  type          String
  reason        String?
  createdAt     DateTime?    @default(now()) @map("created_at") @db.Timestamp(6)
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onUpdate: NoAction)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([appointmentId], map: "idx_credit_transactions_appointment_id")
  @@index([type], map: "idx_credit_transactions_type")
  @@index([userId], map: "idx_credit_transactions_user_id")
  @@map("credit_transactions")
}

model RefundRequest {
  id            String      @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId        String      @map("user_id")
  appointmentId String      @map("appointment_id")
  amount        Decimal     @map("amount") @db.Decimal(10, 2)
  reason        String
  status        String?     @default("pending")
  processedBy   String?     @map("processed_by")
  processedAt   DateTime?   @map("processed_at") @db.Timestamp(6)
  createdAt     DateTime?   @default(now()) @map("created_at") @db.Timestamp(6)
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  processor     User?       @relation("ProcessedRefunds", fields: [processedBy], references: [id], onUpdate: NoAction)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([appointmentId], map: "idx_refund_requests_appointment_id")
  @@index([status], map: "idx_refund_requests_status")
  @@index([userId], map: "idx_refund_requests_user_id")
  @@map("refund_requests")
}

model AppointmentModification {
  id               String      @id @default(dbgenerated("(gen_random_uuid())::text"))
  appointmentId    String      @map("appointment_id")
  modifiedBy       String      @map("modified_by")
  modificationType String      @map("modification_type")
  reason           String?
  oldData          Json        @map("old_data")
  newData          Json        @map("new_data")
  createdAt        DateTime?   @default(now()) @map("created_at") @db.Timestamp(6)
  appointment      Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  modifier         User        @relation(fields: [modifiedBy], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([appointmentId], map: "idx_appointment_modifications_appointment_id")
  @@index([modifiedBy], map: "idx_appointment_modifications_modified_by")
  @@index([modificationType], map: "idx_appointment_modifications_type")
  @@map("appointment_modifications")
}

model Message {
  id            String              @id @default(dbgenerated("(gen_random_uuid())::text"))
  senderId      String              @map("sender_id")
  receiverId    String              @map("receiver_id")
  appointmentId String?             @map("appointment_id")
  content       String
  isRead        Boolean?            @default(false) @map("is_read")
  createdAt     DateTime?           @default(now()) @map("created_at") @db.Timestamp(6)
  attachments   MessageAttachment[]
  appointment   Appointment?        @relation(fields: [appointmentId], references: [id], onUpdate: NoAction)
  receiver      User                @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sender        User                @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([appointmentId], map: "idx_messages_appointment_id")
  @@index([receiverId, isRead], map: "idx_messages_receiver_read")
  @@index([senderId, receiverId], map: "idx_messages_sender_receiver")
  @@map("messages")
}

model MessageAttachment {
  id        String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  messageId String    @map("message_id")
  fileName  String    @map("file_name")
  fileSize  Int       @map("file_size")
  fileType  String    @map("file_type")
  filePath  String    @map("file_path")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  message   Message   @relation(fields: [messageId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([messageId], map: "idx_message_attachments_message_id")
  @@map("message_attachments")
}

model RecurringSession {
  id                String        @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId            String        @map("user_id")
  tutorId           String        @map("tutor_id")
  courseId          String        @map("course_id")
  startDate         DateTime      @map("start_date") @db.Timestamp(6)
  endDate           DateTime?     @map("end_date") @db.Timestamp(6)
  frequency         String
  durationMin       Int           @map("duration_min")
  totalSessions     Int           @map("total_sessions")
  sessionsCreated   Int?          @default(0) @map("sessions_created")
  sessionsCompleted Int?          @default(0) @map("sessions_completed")
  sessionsCancelled Int?          @default(0) @map("sessions_cancelled")
  active            Boolean?      @default(true)
  createdAt         DateTime?     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime?     @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  appointments      Appointment[]
  course            Course        @relation(fields: [courseId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tutor             Tutor         @relation(fields: [tutorId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  slotHolds         SlotHold[]

  @@index([active], map: "idx_recurring_sessions_active")
  @@index([courseId], map: "idx_recurring_sessions_course_id")
  @@index([tutorId], map: "idx_recurring_sessions_tutor_id")
  @@index([userId], map: "idx_recurring_sessions_user_id")
  @@map("recurring_sessions")
}

enum Role {
  student
  tutor
  admin
}

enum AppointmentStatus {
  scheduled
  cancelled
  completed
  refunded
}

enum OrderStatus {
  created
  paid
  failed
  refunded
}

enum CouponType {
  percent
  fixed
}

enum ExternalCalendarProvider {
  google
  microsoft
}

enum WebhookSource {
  stripe
  make
  app
}
